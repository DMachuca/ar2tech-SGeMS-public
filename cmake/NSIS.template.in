# Auto-generated by EclipseNSIS Script Wizard
# Nov 22, 2009 11:55:09 PM

Name SGeMS-ar2Tech-beta-x64

; getting variables from CMAKE
!define INSTALLER_OUTFILE_NAME "@CPACK_NSIS_INSTALLER_OUTFILE_NAME@"

!define AR2GEMS_SOURCE_DIR "@CPACK_NSIS_AR2GEMS_SOURCE_DIR@"
!define AR2GEMS_BINARY_DIR "@CPACK_NSIS_AR2GEMS_BINARY_DIR@\bin\@CPACK_NSIS_AR2GEMS_BUILD_TYPE@\"
!define AR2GEMS_LIB_DIR "@CPACK_NSIS_AR2GEMS_BINARY_DIR@\lib\@CPACK_NSIS_AR2GEMS_BUILD_TYPE@\"
!define AR2GEMS_PLUGINS_DIR "@CPACK_NSIS_AR2GEMS_PLUGINS_DIR@"

!define QT_BINARY_DIR  "@CPACK_NSIS_QT_BINARY_DIR@"
!define QT_PLUGINS_DIR "@CPACK_NSIS_QT_PLUGINS_DIR@"

!define VTK_LIB_DIR "@CPACK_NSIS_VTK_LIB_DIR@"

!define PYTHON27_DIR "@CPACK_NSIS_PYTHON27_DIR@"

!define VC100_CRT "@CPACK_NSIS_VC100_CRT@"
; getting variables from CMAKE


# General Symbol Definitions
!define REGKEY "SOFTWARE\$(^Name)"
!define VERSION 3.0beta
!define COMPANY "Advanced Resources and Risk Technology"
!define URL http://ar2tech.com/sgems

; include for some of the windows messages defines
!include "winmessages.nsh"
; HKLM (all users) vs HKCU (current user) defines
!define env_hklm 'HKU  "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"'
!define env_hkcu 'HKCU "Environment"'
;!define GSTLAPPLIHOME "GSTLAPPLIHOME"


# MUI Symbol Definitions
!define MUI_ICON "${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\ar2gems_icon_256x256.ico"
!define MUI_FINISHPAGE_NOAUTOCLOSE
!define MUI_UNFINISHPAGE_NOAUTOCLOSE

# Included files
!include Sections.nsh
!include MUI2.nsh

# Reserved Files
ReserveFile "${NSISDIR}\Plugins\AdvSplash.dll"

# Variables
Var StartMenuGroup

# Installer pages
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE ${AR2GEMS_SOURCE_DIR}\LICENSE-ar2tech.txt
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

# Installer languages
!insertmacro MUI_LANGUAGE English
!insertmacro MUI_LANGUAGE French
!insertmacro MUI_LANGUAGE Italian
!insertmacro MUI_LANGUAGE German

# Installer attributes
OutFile ${INSTALLER_OUTFILE_NAME}.exe
InstallDir C:\SGeMS-ar2tech-x64
CRCCheck on
XPStyle on
ShowInstDetails hide
VIProductVersion 2.5.0.0
VIAddVersionKey /LANG=${LANG_ENGLISH} ProductName SGeMS-beta
VIAddVersionKey /LANG=${LANG_ENGLISH} ProductVersion "${VERSION}"
VIAddVersionKey /LANG=${LANG_ENGLISH} CompanyWebsite "${URL}"
VIAddVersionKey /LANG=${LANG_ENGLISH} FileVersion "${VERSION}"
VIAddVersionKey /LANG=${LANG_ENGLISH} FileDescription ""
VIAddVersionKey /LANG=${LANG_ENGLISH} LegalCopyright ""
InstallDirRegKey HKLM "${REGKEY}" Path
ShowUninstDetails hide

# Installer sections
Section "Main" SEC0000
    SetOutPath $INSTDIR
    SetOutPath $INSTDIR\encodings
    SetOverwrite on
    File /r ${PYTHON27_DIR}\Lib\encodings\*  
    SetOutPath $INSTDIR
    File ${AR2GEMS_BINARY_DIR}\*.dll
    File ${AR2GEMS_LIB_DIR}\*.lib
    File ${AR2GEMS_BINARY_DIR}\ar2gems.exe
    ;File ${AR2GEMS_BINARY_DIR}\sgems_qss
    ;File c:\code-dev\Qt\4.8.3-x64\\bin\*.dll
    File ${QT_BINARY_DIR}\*.dll
    ;File "c:\Program Files (x86)\Intel\Composer XE 2013\redist\intel64\mkl\*.dll"
    ;File "c:\Program Files (x86)\Intel\Composer XE 2013\redist\intel64\compiler\*.dll"
    File ${VTK_LIB_DIR}\*.dll 
    file "${VC100_CRT}\*.dll"
    File ${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\ar2gems-splash.png
    File ${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\shutter.wav
    ;This is specifically for sgems-UQ
    ;File ${AR2GEMS_PLUGINS_DIR}\Geostat\metrics-data.dll    
    ;File ${AR2GEMS_PLUGINS_DIR}\Geostat\metrics-algo.dll
    SetOutPath $INSTDIR\plugins\colorscales
    File ${AR2GEMS_PLUGINS_DIR}\colorscales\*
    SetOutPath $INSTDIR\plugins\Geostat
;FIXME ;File ${AR2GEMS_PLUGINS_DIR}\Geostat\*.dll
    File ${AR2GEMS_PLUGINS_DIR}\Geostat\*.ui
    ;SetOutPath $INSTDIR\plugins\actions
    ;File /r ${AR2GEMS_PLUGINS_DIR}\actions\*
    SetOutPath $INSTDIR\plugins\designer
	File /r ${QT_PLUGINS_DIR}\designer\*.dll
    SetOutPath $INSTDIR\plugins\imageformats
    File /r ${QT_PLUGINS_DIR}\imageformats\qsvg4.dll    
    SetOutPath $INSTDIR
    File /nonfatal ${PYTHON27_DIR}\libs\python27.dll
    File ${PYTHON27_DIR}\Lib\*.py
    File ${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\ar2gems_icon_256x256.ico
    WriteRegStr HKLM "${REGKEY}\Components" Main 1
    
    ; manage headers
    File /r @CPACK_NSIS_AR2GEMS_BINARY_DIR@\include    
    ;
    
    SetOutPath $INSTDIR\plugins\designer
    File ${AR2GEMS_BINARY_DIR}\ar2gems_widgets.dll 
     
SectionEnd

Section "Main" SEC0010
    SetOutPath $INSTDIR
    SetOutPath $INSTDIR\encodings
    SetOverwrite on
    
    ; manage headers
    ;File /r @CPACK_NSIS_AR2GEMS_BINARY_DIR@\include    
    ; 
    
   ; SETUP AR2GEMS_PLUGINS_DIR ENV variable 
   ; include for some of the windows messages defines
   !include "winmessages.nsh"
   ; HKLM (all users) vs HKCU (current user) defines
   ;!define env_hklm 'HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"'
   ;!define env_hkcu 'HKCU "Environment"'
   ; set variable
   WriteRegExpandStr ${env_hklm} AR2GEMS_PLUGINS_DIR $INSTDIR
   ; make sure windows knows about the change
   ;SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000
   
SectionEnd   

Section "post" SEC0001
    WriteRegStr HKLM "${REGKEY}" Path $INSTDIR
    
    ;WriteRegExpandStr ${env_hkcu} VTK_AUTOLOAD_PATH $INSTDIR
    ;WriteRegExpandStr ${env_hkcu} GSTLAPPLIHOME $INSTDIR
   ; make sure windows knows about the change
    SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000    
    WriteUninstaller $INSTDIR\sgems-ar2tech-beta-uninstall.exe
    SetOutPath $SMPROGRAMS\$StartMenuGroup
    SetOutPath $INSTDIR
    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\$(^UninstallLink).lnk" $INSTDIR\sgems-ar2tech-beta-uninstall.exe
    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\$(^Name).lnk" "$INSTDIR\ar2gems.exe" "" "$INSTDIR\ar2gems_icon_256x256.ico"
    CreateShortcut "$DESKTOP\$(^Name).lnk" "$INSTDIR\ar2gems.exe" "" "$INSTDIR\ar2gems_icon_256x256.ico"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayName "$(^Name)"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayVersion "${VERSION}"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" URLInfoAbout "${URL}"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayIcon $INSTDIR\sgems-ar2tech-beta-uninstall.exe
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" UninstallString $INSTDIR\sgems-ar2tech-beta-uninstall.exe
    WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoModify 1
    WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoRepair 1
SectionEnd

# Macro for selecting uninstaller sections
!macro SELECT_UNSECTION SECTION_NAME UNSECTION_ID
    Push $R0
    ReadRegStr $R0 HKLM "${REGKEY}\Components" "${SECTION_NAME}"
    StrCmp $R0 1 0 next${UNSECTION_ID}
    !insertmacro SelectSection "${UNSECTION_ID}"
    GoTo done${UNSECTION_ID}
next${UNSECTION_ID}:
    !insertmacro UnselectSection "${UNSECTION_ID}"
done${UNSECTION_ID}:
    Pop $R0
!macroend

# Uninstaller sections
Section /o "un.Main" UNSEC0000
    Delete /REBOOTOK $INSTDIR\LICENSE.GPL
    Delete /REBOOTOK $INSTDIR\AUTHORS
    Delete /REBOOTOK $INSTDIR\python27.dll
    RmDir /r /REBOOTOK $INSTDIR\plugins\designer
    Delete /REBOOTOK $INSTDIR\QtXml4.dll
    Delete /REBOOTOK $INSTDIR\QtOpenGL4.dll
    Delete /REBOOTOK $INSTDIR\QtGui4.dll
    Delete /REBOOTOK $INSTDIR\QtDesigner4.dll
    Delete /REBOOTOK $INSTDIR\QtCore4.dll
    RmDir /r /REBOOTOK $INSTDIR
    RmDir /r /REBOOTOK $INSTDIR\encodings
    
    ;; manage headers
    RmDir /r /REBOOTOK $INSTDIR\include    
    ;;
    
    DeleteRegValue HKLM "${REGKEY}\Components" Main
SectionEnd

Section "un.post" UNSEC0001
    DeleteRegKey HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)"
    DeleteRegValue ${env_hklm} GSTLAPPLIHOME
    Delete  "$SMPROGRAMS\$StartMenuGroup\$(^UninstallLink).lnk"
    Delete  "$SMPROGRAMS\$StartMenuGroup\$(^Name).lnk"
    Delete  "$DESKTOP\$(^Name).lnk"
    Delete  $INSTDIR\sgems-ar2tech-beta-uninstall.exe
    DeleteRegValue HKLM "${REGKEY}" Path
    DeleteRegKey /IfEmpty HKLM "${REGKEY}\Components"
    DeleteRegKey /IfEmpty HKLM "${REGKEY}"
    RmDir /REBOOTOK $SMPROGRAMS\$StartMenuGroup
    RmDir /REBOOTOK $INSTDIR
SectionEnd

# Installer functions
Function .onInit
    ;radio button
    Initpluginsdir ; Make sure $pluginsdir exists
	StrCpy $1 ${SEC0000} ;The default
    ;
    
    
    InitPluginsDir
    StrCpy $StartMenuGroup $(^Name)
    Push $R1
    File /oname=$PLUGINSDIR\spltmp.bmp ${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\ar2gems_splash.bmp
    advsplash::show 1000 600 400 -1 $PLUGINSDIR\spltmp
    Pop $R1
    Pop $R1
    
    ;radio button
    Initpluginsdir ; Make sure $pluginsdir exists
	StrCpy $1 ${-Main} ;The default
    ;
FunctionEnd

# Uninstaller functions
Function un.onInit
    ReadRegStr $INSTDIR HKLM "${REGKEY}" Path
    StrCpy $StartMenuGroup $(^Name)
    !insertmacro SELECT_UNSECTION Main ${UNSEC0000}
FunctionEnd

# Installer Language Strings
# TODO Update the Language Strings with the appropriate translations.

LangString ^UninstallLink ${LANG_ENGLISH} "Uninstall $(^Name)"
LangString ^UninstallLink ${LANG_FRENCH} "Uninstall $(^Name)"
LangString ^UninstallLink ${LANG_ITALIAN} "Uninstall $(^Name)"
LangString ^UninstallLink ${LANG_GERMAN} "Uninstall $(^Name)"


; radio button
Function .onSelChange
!insertmacro StartRadioButtons $1
    !insertmacro RadioButton ${SEC0000}
    !insertmacro RadioButton ${SEC0010}
!insertmacro EndRadioButtons
FunctionEnd
;

